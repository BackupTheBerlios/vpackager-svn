' Gambas module file

'    This file is part of vpackager

'    vpackager is free software: you can redistribute it and/or modify
'    it under the terms of the GNU General Public License as published by
'    the Free Software Foundation, either version 3 of the License, or
'    (at your option) any later version.

'    vpackager  is distributed in the hope that it will be useful,
'    but WITHOUT ANY WARRANTY; without even the implied warranty of
'    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
'    GNU General Public License for more details.

'    You should have received a copy of the GNU General Public License
'    along with vpackager.  If not, see <http://www.gnu.org/licenses/>.

PUBLIC SUB GENERATE_BUILD_SCRIPT()
  
  DIM sHeader AS String
  DIM sBody AS String
  DIM sFooter AS String
  DIM sDisclaimer AS String
  DIM sScript AS String
  DIM sTarget AS String
  DIM sGoBack AS String
  
  'sScript.Add("#!/bin/bash")
  sDisclaimer = "#!/bin/bash \n \n " &
  "# This script was auto-generated by " & Global.sMyname & gb.NewLine &
  gb.NewLine &
  gb.NewLine &
  "# LICENSE" & gb.NewLine &
  "#  vpackager is free software: you can redistribute it and/or modify" & gb.NewLine &
  "#  it under the terms of the GNU General Public License as published by" & gb.NewLine &
  "#  the Free Software Foundation, either version 3 of the License, or" & gb.NewLine &
  "#  (at your option) any later version." & gb.NewLine &
  gb.NewLine &
  gb.NewLine &
  "# vpackager  is distributed in the hope that it will be useful," & gb.NewLine &
  "# but WITHOUT ANY WARRANTY; without even the implied warranty of" & gb.NewLine &
  "# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the" & gb.NewLine &
  "# GNU General Public License for more details." & gb.NewLine &
  gb.NewLine &
  "# You should have received a copy of the GNU General Public License" & gb.NewLine &
  "# along with vpackager.  If not, see <http://www.gnu.org/licenses/>." & gb.NewLine &
  "\n" &
  "\n # This script shall enherit vpackager's license agreement terms"
  
  ' ADD THE VITAL VARIABLES TO THE SCRIPT
  sHeader = "PWD=$(pwd) \n" &
  "NAME=" & ClsBuildVars.SNAME & "\n" &
  "VERSION=" & ClsBuildVars.sVersion & "\n" &
  "REL=" & ClsBuildVars.sRel & "\n" &
  "TAG=" & ClsBuildVars.sTag & "\n" &
  "ARCH=" & ClsBuildVars.sArch & "\n" &
  "TYPE=" & ClsBuildVars.sType & "\n" &
  "SRCFILE=" & File.Name(ClsBuildVars.sSrcPath) & "\n" &
  "BUILD_DIR=$PWD/$NAME-$VERSION/build \n" &
  "PKG=$BUILD_DIR/PKG \n" &
  "CONFIG_STRING=\'" & clsGenScript.CONFIG_USED & "\'"
  
  sBody = "tar xf $PWD/$SRCFILE \n"
  
  IF InStr(clsGenScript.CONFIG_COMMAND, "configure") THEN 
  
  sBody = sBody & "mkdir -p $BUILD_DIR \n" &
  "cd $BUILD_DIR \n ../configure \\ \n " & 
  clsGenScript.CONFIG_USED & "\n" &  
  "make \n" &
  "mkdir -p $PKG \n" &
  "make DESTDIR=$PKG install \n"
  sGoBack = "../../../"
  ELSE IF InStr(clsGenScript.CONFIG_COMMAND, "CMake") THEN 
      sBody = sBody & " mkdir -p $BUILD_DIR \n" &
      "cd $BUILD_DIR \n cmake " & clsGenScript.CONFIG_USED & ".." &
      "make \n" &
      "mkdir -p $PKG \n" &
      "make DESTDIR=$PKG install \n" 
      sGoBack = "../../../"
  ELSE IF InStr(clsGenScript.CONFIG_COMMAND, "python") THEN 
    sGoBack = "../../"
    sBody = sBody & "\n " &
    "BUILD_DIR=$PWD/$NAME-$VERSION \n" &
    "PKG=$PWD/$NAME-$VERSION/PKG \n" &
    "mkdir -p $PKG" & clsGenScript.sPrefix_Used & " \n " &
    "cd $NAME-$VERSION \n" &
    "python setup.py install --prefix=$PKG" & clsGenScript.sPrefix_Used & " \n"
  END IF
    
    IF ClsBuildVars.sSlackDesc THEN 
      sFooter = "mkdir -p $PKG/install \n" &
      "echo \' \n" & File.Load(ClsBuildVars.sSlackDesc) & "\' > $PKG/install/slack-desc \n \n"
    END IF
  sFooter = sFooter & "cd $PKG \n" &
  clsGenScript.PACKAGE_COMMAND & " $NAME-$VERSION-$ARCH-$REL$TAG.$TYPE \n" &
  "cd " & sGoBack & " \n" &
  "cp $PKG/*.tlz $PWD \n" &
  "exit 0 \n"
  
  
  
  
  
  sScript = sDisclaimer & "\n \n" &
  sHeader & "\n \n" & sBody & "\n" & "\n" &
  sFooter
  
 ' save the file
 'File.Save(File.Dir(ClsBuildVars.sSrcPath) &/ ClsBuildVars.sName & "-" & ClsBuildVars.sVersion & ".build", SConv(sScript))

 sTarget = File.Dir(ClsBuildVars.sSrcPath) &/ ClsBuildVars.sName & "-" & ClsBuildVars.sVersion & "_build"
  IF Exist(sTarget) THEN 
    KILL sTarget
  END IF
  File.Save(sTarget, SConv(sScript))
  
  
END
